---
title: 利用群晖的反向代理服务器转发内网服务,实现外网免端口访问内网服务
date: 2019-04-07 13:01:58
categories:
  - DSM
tags:
  - LEDE
  - DSM
  - nginx
  - Openwrt
  - ROS
---

<!--more-->

如果要在外网访问家里的一些服务，如：群晖 NAS,op/lede 路由等等，这时候就要在主路由器里进行端口映射。当要映射的服务非常多时，在路由器里就要配置很多条端口映射。而且多个服务映射到外网后，外网访问的时候通常是要加上端口号的。如果想外网访问不加端口，这时候要就用上 nginx 的反向代理功能了。
通过在 nginx 里配置虚拟主机，实现外网同一个端口（80 或 443）访问内网多个服务。
如果自己配置 nginx 的虚拟主机、反向代理挺麻烦的（愿意动手的可以自己配置）,这时候我们需要借助群晖 NAS 的反向代理功能来简化我们的配置。

### 一、前期准备

1. 外网 IP：宽带拨号后是公网 IP，如果是拨号后是内网 IP，请使用内网穿透工具。
2. 一个域名：自己买或用免费的都行
3. 泛域名(\*.yourdomain.com)证书(非必须)：如果当地宽带 80 端口没被封，可以不用证书，如果 80 被封，这时候就要使用 443 端口（如果 443 端口也被封的，那就老老实实带端口访问吧）。使用 443 端口时如果不想浏览器有错误提示最好申请一个证书, 免费的 SSL 证书 let's encrypt 用的比较多。不用泛域名证书，用单个域名证书也可以，用单域名证书时在群晖 NAS 配置有点区别，本文是以泛域名证书为例.

### 二、DDNS 配置

\* 本方以 koolshare 论坛 LEDE 下 koolddns 插件配置域名 yourdomain.com 为例进行配置, 域名供应商以 aliyun 为例

1. 进到阿里云控制台取得 AccessKey ID 和 Access Key Secret。
   ![图片 1](1.jpg)
   ![图片 2](2.jpg)

2. 在 lede 的 koolddns 插件下进行配置 DDNS
   ![图片 3](3.jpg)

### 三、主路由端口映射

\*以 ROS 路由为例，将外网端口 443 映射到内网群晖(192.168.1.253)的 443 端口
![图片 4](4.jpg)
![图片 5](5.jpg)

### 四、群晖反向代理配置

1. 进入群晖控制台->安全->证书
   ![图片 6](6.jpg)

2. 新增证书，设置证书为默认证书
   ![图片 7](7.jpg)
   ![图片 8](8.jpg)
   ![图片 9](9.jpg)

3. 进入群晖控制台->应用程序入口->反向代理服务器
   ![图片 10](10.jpg)

4. 新增反向代理
   ![图片 11](11.jpg)

5. enjoy it
   ![图片 12](12.jpg)
   ![图片 13](13.jpg)
   ![图片 14](14.jpg)
